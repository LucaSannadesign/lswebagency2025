---
// src/sitemap.astro
import Layout from '@/layouts/PageLayout.astro';
import { getCollection } from 'astro:content';

export const prerender = true;

/* Helper: ricava lo slug dal path file (ultimo segmento senza estensione) */
const fileSlug = (id: string) =>
  id.split('/').pop()?.replace(/\.[^.]+$/, '') || id;

/* Contenuti dinamici */
const posts = await getCollection('post');
const portfolio = await getCollection('portfolio');

/* Pagine statiche principali */
const staticPages = [
  { title: 'Home', url: '/' },
  { title: 'Chi Siamo', url: '/chi-siamo' },
  { title: 'Servizi', url: '/servizi' },
  { title: 'Portfolio', url: '/portfolio' },
  { title: 'Blog', url: '/blog' },
  { title: 'Contatti', url: '/contatti' },
  { title: 'Pagamenti', url: '/pagamenti' },
];

/* SEO della pagina */
const metadata = {
  title: 'Mappa del Sito | LS Web Agency',
  description:
    'Elenco completo delle pagine del sito: principali, articoli del blog e progetti portfolio.',
  canonical: '/sitemap',
  robots: { index: true, follow: true },
};
---

<Layout metadata={metadata}>
  <section class="container mx-auto px-6 py-12">
    <h1 class="text-4xl font-bold text-center mb-8">Mappa del Sito</h1>
    <p class="text-center text-lg text-gray-600 dark:text-gray-300 mb-10">
      Naviga tutte le pagine del sito, inclusi articoli del blog e progetti.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Pagine Statiche -->
      <div>
        <h2 class="text-2xl font-semibold mb-4">Pagine principali</h2>
        <ul class="space-y-2">
          {staticPages.map((page) => (
            <li>
              <a href={page.url} class="text-blue-600 hover:underline">{page.title}</a>
            </li>
          ))}
        </ul>
      </div>

      <!-- Blog -->
      <div>
        <h2 class="text-2xl font-semibold mb-4">Articoli del Blog</h2>
        <ul class="space-y-2">
          {posts.map((post) => {
            // ⬇️ Safe-cast richiesta
            const slug = (post as any).data?.slug?.trim?.() || (post as any).slug || post.id;
            return (
              <li>
                <a href={`/blog/${slug}`} class="text-blue-600 hover:underline">
                  {post.data.title}
                </a>
              </li>
            );
          })}
        </ul>
      </div>

      <!-- Portfolio -->
      <div>
        <h2 class="text-2xl font-semibold mb-4">Portfolio</h2>
        <ul class="space-y-2">
          {portfolio.map((item) => {
            const slug =
              (item.data as any)?.slug?.trim?.() || fileSlug(item.id);
            const href =
              (item.data as any)?.permalink?.trim?.() || `/portfolio/${slug}`;
            return (
              <li>
                <a href={href} class="text-blue-600 hover:underline">
                  {item.data.title}
                </a>
              </li>
            );
          })}
        </ul>
      </div>

    </div>
  </section>
</Layout>
