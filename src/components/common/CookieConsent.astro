---
/**
 * Banner cookie self-hosted + Google Consent Mode v2.
 * Carica GA4 SOLO dopo consenso (usa PUBLIC_GA4_ID se presente).
 */
const GA_ID = import.meta.env.PUBLIC_GA4_ID || '';
---

<div
  id="cookie-banner"
  class="hidden fixed inset-x-0 bottom-0 z-[9999] border-t ring-1 ring-neutral-200 dark:ring-neutral-800
         bg-white/95 dark:bg-neutral-900/95 backdrop-blur supports-[backdrop-filter]:bg-white/70">
  <div class="mx-auto max-w-5xl px-5 py-4 flex flex-col sm:flex-row items-start sm:items-center gap-4">
    <p class="text-sm text-neutral-700 dark:text-neutral-300 flex-1">
      Usiamo cookie tecnici e, previo consenso, cookie analitici/marketing.
      Puoi accettare o rifiutare ora e cambiare scelta in qualsiasi momento.
      Leggi la nostra <a href="/privacy-cookie-policy" class="underline">Cookie Policy</a>.
    </p>

    <div class="flex gap-2 shrink-0">
      <button type="button" class="px-4 py-2 rounded-full ring-1 ring-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800"
              onclick="window.__rejectAllCookies?.()">
        Rifiuta
      </button>
      <button type="button" class="px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700"
              onclick="window.__acceptAllCookies?.()">
        Accetta
      </button>
    </div>
  </div>
</div>

<script is:inline define:vars={{ GA_ID }}>
(function () {
  const KEY = 'lsw-consent-v2';
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }

  // Default: tutto negato tranne storage funzionali/sicurezza
  gtag('consent', 'default', {
    ad_storage: 'denied',
    analytics_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
    functionality_storage: 'granted',
    security_storage: 'granted',
    wait_for_update: 500
  });

  function $(id){ return document.getElementById(id); }
  function show(){ $('cookie-banner')?.classList.remove('hidden'); }
  function hide(){ $('cookie-banner')?.classList.add('hidden'); }

  function loadGA() {
    if (!GA_ID || window.__gaLoaded) return;
    window.__gaLoaded = true;

    // carica la libreria gtag
    const s = document.createElement('script');
    s.async = true;
    s.src = `https://www.googletagmanager.com/gtag/js?id=${GA_ID}`;
    document.head.appendChild(s);

    // inizializza
    gtag('js', new Date());
    gtag('config', GA_ID, { anonymize_ip: true });
  }

  function applyConsentFromStorage() {
    const saved = localStorage.getItem(KEY);
    if (saved === 'granted') {
      gtag('consent', 'update', {
        ad_storage: 'granted',
        analytics_storage: 'granted',
        ad_user_data: 'granted',
        ad_personalization: 'granted'
      });
      loadGA();
    }
    return saved;
  }

  // Bottoni globali (e per eventuale link “Gestisci consenso” nel footer)
  window.__acceptAllCookies = function () {
    localStorage.setItem(KEY, 'granted');
    gtag('consent', 'update', {
      ad_storage: 'granted',
      analytics_storage: 'granted',
      ad_user_data: 'granted',
      ad_personalization: 'granted'
    });
    loadGA();
    hide();
  };

  window.__rejectAllCookies = function () {
    localStorage.setItem(KEY, 'denied');
    gtag('consent', 'update', {
      ad_storage: 'denied',
      analytics_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied'
    });
    hide();
  };

  window.__openConsentBanner = function () { show(); };

  // Prima vista
  document.addEventListener('DOMContentLoaded', function () {
    const saved = applyConsentFromStorage();
    if (!saved) show();
  });

  // Navigazioni client-side (Astro View Transitions)
  document.addEventListener('astro:after-swap', function () {
    const saved = applyConsentFromStorage();
    if (!saved) show();
  });
})();
</script>