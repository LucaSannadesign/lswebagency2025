---
import { APP_BLOG } from 'astrowind:config';
import type { Post } from '@/types';
import type { ImageMetadata } from 'astro';

import { findImage } from '@/utils/images';
import { getPermalink } from '@/utils/permalinks';

export interface Props {
  post: Post;
}

const { post } = Astro.props;

const image = await findImage(post.image);
const link = APP_BLOG?.post?.isEnabled ? getPermalink(post.permalink, 'post') : '';

// Ottieni l'URL dell'immagine come stringa per background-image
let imageUrl: string | null = null;
if (image) {
  if (typeof image === 'string') {
    imageUrl = image;
  } else if (typeof image === 'object' && image !== null && 'src' in image) {
    const src = (image as ImageMetadata).src;
    imageUrl = typeof src === 'string' ? src : null;
  }
}

const excerpt = (post?.excerpt ?? '').trim();
---

<article class="mb-6 transition">
  {
    imageUrl ? (
      <div
        class="relative w-full overflow-hidden rounded-2xl bg-slate-100 dark:bg-slate-700 aspect-[16/10] bg-center bg-no-repeat bg-cover mb-6"
        style={`background-image: url(${imageUrl});`}
      >
        {/* Immagine nascosta per accessibilit√† */}
        <img src={imageUrl} alt={post.title} class="sr-only" />
        {link && (
          <a href={link} class="absolute inset-0" aria-label={`Leggi: ${post.title}`}></a>
        )}
      </div>
    ) : (
      <div class="relative w-full overflow-hidden rounded-2xl bg-slate-100 dark:bg-slate-700 aspect-[16/10] mb-6"></div>
    )
  }

  <h3 class="text-xl sm:text-2xl font-bold leading-tight mb-2 font-heading dark:text-slate-300">
    {
      link ? (
        <a class="inline-block hover:text-primary dark:hover:text-blue-700 transition ease-in duration-200" href={link}>
          {post.title}
        </a>
      ) : (
        post.title
      )
    }
  </h3>

  {excerpt && <p class="text-muted dark:text-slate-400 text-lg">{excerpt}</p>}
</article>